// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 用户模型
model User {
  id           String   @id @default(uuid())
  username     String   @unique
  password     String
  nickname     String
  role         String   @default("student") // student, teacher, parent, admin
  avatar       String?
  telegramId   String?  // Telegram 绑定 ID
  level        Int      @default(1)
  exp          Int      @default(0)
  coins        Int      @default(0)
  streak       Int      @default(0)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关系
  wordProgress WordProgress[]
  wrongWords  WrongWord[]
  gameRecords GameRecord[]
  achievements UserAchievement[]
  dailyStats  DailyStat[]
}

// 词库模型
model Word {
  id          String   @id @default(uuid())
  word        String   @unique
  phonetic    String
  meaning     String
  example     String?
  exampleCn   String?
  audioUrl    String?
  imageUrl    String?
  level       String   // KET, PET, Starters, Movers, Flyers, 小学1-3, 小学4-6
  category    String?
  tags        String?  // 逗号分隔的标签
  createdAt   DateTime @default(now())

  // 关系
  progress    WordProgress[]
  wrongWords  WrongWord[]
  reviewCards ReviewCard[]
}

// 学习进度
model WordProgress {
  id          String   @id @default(uuid())
  userId      String
  wordId      String
  status      String   @default("new") // new, learning, mastered
  correctCount Int     @default(0)
  wrongCount  Int      @default(0)
  lastReviewAt DateTime?
  nextReviewAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
}

// 错题本
model WrongWord {
  id          String   @id @default(uuid())
  userId      String
  wordId      String
  category    String   @default("spelling") // spelling, listening, reading, grammar
  wrongCount  Int      @default(1)
  lastWrongAt DateTime @default(now())
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
}

// 复习卡片 (艾宾浩斯记忆曲线)
model ReviewCard {
  id          String   @id @default(uuid())
  userId      String
  wordId      String
  interval    Int      @default(1) // 当前间隔天数
  easeFactor  Float    @default(2.5) // 难度因子
  repetitions Int      @default(0) // 复习次数
  nextReview  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
}

// 游戏记录
model GameRecord {
  id          String   @id @default(uuid())
  userId      String
  gameType    String   // sprint, target, match, quiz
  score       Int
  expEarned   Int      @default(0)
  coinsEarned Int      @default(0)
  playedAt    DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 成就
model Achievement {
  id          String   @id @default(uuid())
  code        String   @unique // unique achievement code
  name        String
  description String
  icon        String
  expReward   Int      @default(0)
  coinReward  Int      @default(0)
  createdAt   DateTime @default(now())

  users       UserAchievement[]
}

// 用户成就
model UserAchievement {
  id             String       @id @default(uuid())
  userId         String
  achievementId  String
  earnedAt       DateTime     @default(now())

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement    Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
}

// 每日统计
model DailyStat {
  id            String   @id @default(uuid())
  userId        String
  date          String   // YYYY-MM-DD 格式
  wordsLearned  Int      @default(0)
  wordsReviewed Int      @default(0)
  practiceTime  Int      @default(0) // 分钟
  gamesPlayed   Int      @default(0)
  expEarned    Int      @default(0)
  coinsEarned  Int      @default(0)
  createdAt    DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

// 系统配置
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  desc      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
